#!/usr/bin/env python
############################################################################
# T. Trainor
#
# -------------
# Modifications
# -------------
#
#
############################################################################

import os, string, sys, getopt
#import ConfigParser

##############################################################
# test for command line switches
##############################################################
use_wxGUI = False
debug     = False
verbose   = False
do_shell  = True

libs      = []
files     = []

opts, args = getopt.getopt(sys.argv[1:], "wdvhxl:")
#print opts
#print args
for o, a in opts:
    if o == '-w':
        use_wxGUI = True
    elif o == '-d':
        debug = True
    elif o == '-v':
        verbose = True
    elif o == '-x':
        do_shell = False
    elif o == '-l':
        libs.append(a)
    elif o == '-h':
        print 'Startup options for tdl:'
        print '-h:  help'
        print '-w:  use wx GUI'
        print '-d: debug on'
        print '-l: load library'
        print '-v: verbose'
        print '-x: non-interactive execution'
        print 'Examples (combine the various options):'
        print '>tdl -v                  #verbose startup'
        print '>tdl -vd                 #verbose startup and debug on'
        print '>tdl -w                  #use wx GUI'
        print '>tdl -v  fname1 fname2   #verbose and execute files'
        print '>tdl fname1 fname2       #defaults and execute files'
        print '>tdl -l Lib1 -l Lib2     # load libraries at startup'
        sys.exit()

#################################################################
# import and set default paths
# additional paths should be set in the startup.tdl files
#################################################################
try:
    import lib as tdl
    devel = True
    print '  ############## This is TDL EXPERIMENTAL ##############'
except ImportError:
    print 'could not load '
    import tdl
    devel = False

lib_path  = os.path.abspath(tdl.__path__[0])
if devel:
    tdl_root  = os.path.dirname(lib_path)
else:
    tdl_root = lib_path
module_path = os.path.join(tdl_root,'modules')

try:
    if verbose:
        print ' == tdl paths:'
        print '    lib_path   = %s  ' % lib_path
        print '    tdl_root   = %s  ' % tdl_root
        print '    module_path = %s  ' % module_path
    tdl.Util.set_path(lib_path,verbose=verbose)
    tdl.Util.set_path(module_path,recurse=True,verbose=verbose)
    tdl.Util.set_path('.',verbose=verbose)
except:
    print "Error setting paths"
    pass

##############################################################
# startup  files:
#   first site-wide ==> module_path/startup.tdl
#   then from user's home dir ==> ~/.tdl_init
# files contains tuples of (file, Warn_if_Not_Exist_Flag)
##############################################################
files = [(os.path.join(module_path,'startup.tdl'),False)]
user_home = os.path.expanduser('~')
files.append((os.path.join(user_home,'.tdl_init'),False))

# the rest of the arg line are added files
if args is not None:
    for f in args: files.append((f,True))

if verbose:
    print " == Command line Libraries:"
    for l in libs: print l
    print " == Startup files:"
    for f in files: print f

# create a dictionary of default _sys variables
sys_vars = {}
sys_vars['_sys.home'] = user_home
if os.getenv("work"):
    sys_vars['_sys.work'] = os.getenv("work")
elif os.getenv("WORK"):
    sys_vars['_sys.work'] = os.getenv("WORK")
else:
    sys_vars['_sys.work'] = os.getcwd()
sys_vars['_sys.file_path'] = sys_vars['_sys.work']

##########################################################
# run it
##########################################################
if use_wxGUI == False:
    t = tdl.shell(libs=libs,debug=debug,GUI='TkAgg')
    for var in sys_vars.keys():
        t.tdl.setVariable(var,sys_vars[var])
    for f,warn in files:
        if os.path.exists(f) and os.path.isfile(f):
            t.tdl_execute("load('%s')" % f)
        elif warn:
            print "\n  ***Cannot find tdl file: %s" % f
    if do_shell: t.cmdloop()
elif use_wxGUI == True:
    # tdl gets started from within the wxGUI
    # looks like dir gets reset when call application
    work_dir = os.getcwd()
    from wxGUI import wxGUI
    wxGUI.tdl      = tdl
    wxGUI.libs     = libs
    wxGUI.intro    = None
    wxGUI.debug    = debug
    wxGUI.files    = files
    wxGUI.sys_vars = sys_vars
    wxGUI.rsrc_path = module_path
    rsrc = os.path.join(module_path,'wxGUI','wxGUI.rsrc.py')
    # the wxGUI code handles creation of tdl...
    gui = wxGUI.model.Application(wxGUI.wxGUI, aFileName=rsrc)
    os.chdir(work_dir)
    gui.MainLoop()
